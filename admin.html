<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DUBIS Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: #0d0d0d;
      color: #e8e0d5;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .admin-logo {
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 6px;
      color: #c8a96e;
      font-family: Georgia, serif;
      margin-bottom: .5rem;
    }

    .admin-sub {
      color: #555;
      font-size: .75rem;
      letter-spacing: 2px;
      margin-bottom: 2.5rem;
    }

    .login-card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 380px;
    }

    .login-card h2 {
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
      color: #e8e0d5;
    }

    .form-group { margin-bottom: 1rem; }

    .form-group label {
      display: block;
      font-size: .75rem;
      color: #888;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: .4rem;
    }

    .form-group input {
      width: 100%;
      padding: .7rem 1rem;
      background: #111;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      color: #e8e0d5;
      font-size: .9rem;
      outline: none;
      transition: border-color .2s;
    }

    .form-group input:focus { border-color: #c8a96e; }

    .btn-gold {
      width: 100%;
      padding: .85rem;
      background: #c8a96e;
      color: #0d0d0d;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      font-size: .9rem;
      letter-spacing: 1px;
      cursor: pointer;
      transition: opacity .2s;
      margin-top: .5rem;
    }

    .btn-gold:hover { opacity: .85; }
    .btn-gold:disabled { opacity: .5; cursor: not-allowed; }

    .error-msg {
      color: #ef4444;
      font-size: .82rem;
      margin-top: .75rem;
      text-align: center;
    }

    /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
    #dashboard { display: none; padding: 0; }

    .topbar {
      background: #111;
      border-bottom: 1px solid #1e1e1e;
      padding: .85rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .topbar-logo {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 4px;
      color: #c8a96e;
      font-family: Georgia, serif;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .topbar-email { color: #555; font-size: .8rem; }

    .btn-sm {
      padding: .4rem .9rem;
      border-radius: 5px;
      font-size: .75rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid #333;
      background: transparent;
      color: #888;
      transition: color .2s, border-color .2s;
    }

    .btn-sm:hover { color: #e8e0d5; border-color: #555; }

    .main-content { padding: 2rem 1.5rem; max-width: 1200px; margin: 0 auto; }

    /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #1a1a1a;
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
    }

    .stat-label {
      font-size: .7rem;
      color: #555;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: .4rem;
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: #c8a96e;
    }

    .stat-sub { font-size: .78rem; color: #666; margin-top: .2rem; }

    /* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
    .filters {
      display: flex;
      gap: .75rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: .35rem .9rem;
      border-radius: 20px;
      font-size: .78rem;
      cursor: pointer;
      border: 1px solid #2a2a2a;
      background: transparent;
      color: #666;
      transition: all .2s;
    }

    .filter-btn:hover, .filter-btn.active {
      border-color: #c8a96e;
      color: #c8a96e;
      background: rgba(200,169,110,.08);
    }

    .search-input {
      padding: .4rem .9rem;
      border-radius: 6px;
      border: 1px solid #2a2a2a;
      background: #111;
      color: #e8e0d5;
      font-size: .82rem;
      outline: none;
      margin-left: auto;
      width: 220px;
    }

    .search-input:focus { border-color: #c8a96e; }

    /* ‚îÄ‚îÄ Orders Table ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .83rem;
    }

    th {
      text-align: left;
      padding: .6rem 1rem;
      color: #555;
      font-size: .68rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      border-bottom: 1px solid #1e1e1e;
      white-space: nowrap;
    }

    td {
      padding: .85rem 1rem;
      border-bottom: 1px solid #141414;
      vertical-align: middle;
    }

    tr:hover td { background: rgba(255,255,255,.02); }

    .status-badge {
      display: inline-block;
      padding: .25rem .65rem;
      border-radius: 20px;
      font-size: .7rem;
      font-weight: 600;
      letter-spacing: .5px;
    }

    .status-pending      { background: rgba(245,158,11,.15); color: #f59e0b; }
    .status-in_production{ background: rgba(59,130,246,.15);  color: #3b82f6; }
    .status-shipped      { background: rgba(139,92,246,.15);  color: #8b5cf6; }
    .status-delivered    { background: rgba(34,197,94,.15);   color: #22c55e; }
    .status-cancelled    { background: rgba(239,68,68,.15);   color: #ef4444; }

    .order-id { font-family: monospace; color: #888; font-size: .78rem; }
    .amount   { color: #c8a96e; font-weight: 600; }

    .track-link {
      color: #c8a96e;
      text-decoration: none;
      font-size: .75rem;
    }

    .track-link:hover { text-decoration: underline; }

    .items-summary { color: #888; font-size: .78rem; max-width: 200px; }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #444;
    }

    .empty {
      text-align: center;
      padding: 3rem;
      color: #444;
    }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      .main-content { padding: 1rem; }
      .search-input { width: 100%; margin-left: 0; }
      td.hide-mobile, th.hide-mobile { display: none; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="admin-logo">DUBIS</div>
  <div class="admin-sub">ADMIN PORTAL</div>
  <div class="login-card">
    <h2>Sign in to continue</h2>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="admin-email" placeholder="admin@dubis.net" autocomplete="email">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="admin-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
             onkeydown="if(event.key==='Enter') adminLogin()">
    </div>
    <button class="btn-gold" id="btn-login" onclick="adminLogin()">Sign In</button>
    <div class="error-msg" id="login-error"></div>
  </div>
</div>

<!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="dashboard">
  <div class="topbar">
    <div class="topbar-logo">DUBIS</div>
    <div class="topbar-right">
      <span class="topbar-email" id="admin-user-email"></span>
      <button class="btn-sm" onclick="adminLogout()">Sign out</button>
    </div>
  </div>

  <div class="main-content">
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Orders</div>
        <div class="stat-value" id="stat-total">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Revenue</div>
        <div class="stat-value" id="stat-revenue">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today's Revenue</div>
        <div class="stat-value" id="stat-today">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="stat-pending">‚Äî</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Shipped</div>
        <div class="stat-value" id="stat-shipped">‚Äî</div>
      </div>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all"    onclick="setFilter('all',this)">All</button>
      <button class="filter-btn" data-filter="pending"       onclick="setFilter('pending',this)">Pending</button>
      <button class="filter-btn" data-filter="in_production" onclick="setFilter('in_production',this)">In Production</button>
      <button class="filter-btn" data-filter="shipped"       onclick="setFilter('shipped',this)">Shipped</button>
      <button class="filter-btn" data-filter="delivered"     onclick="setFilter('delivered',this)">Delivered</button>
      <button class="filter-btn" data-filter="cancelled"     onclick="setFilter('cancelled',this)">Cancelled</button>
      <input class="search-input" type="text" id="search-input"
             placeholder="Search email or order ID‚Ä¶" oninput="renderTable()">
    </div>

    <div class="table-wrap">
      <div class="loading" id="table-loading">Loading orders‚Ä¶ üêæ</div>
      <table id="orders-table" style="display:none">
        <thead>
          <tr>
            <th>Date</th>
            <th>Order ID</th>
            <th class="hide-mobile">Email</th>
            <th>Items</th>
            <th>Status</th>
            <th>Amount</th>
            <th class="hide-mobile">Tracking</th>
          </tr>
        </thead>
        <tbody id="orders-tbody"></tbody>
      </table>
      <div class="empty" id="table-empty" style="display:none">No orders found.</div>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL  = 'https://ntzwvqtpdmvvavbhuyeb.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50end2cXRwZG12dmF2Ymh1eWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODk1ODAsImV4cCI6MjA4NzI2NTU4MH0.EpfZAg28aU6_sOblfkVpkAwp9nDvXMTRCCNz0UJWHEc';

  let _sb = null;
  let _allOrders = [];
  let _currentFilter = 'all';

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.addEventListener('DOMContentLoaded', async () => {
    _sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, storageKey: 'dubis-admin-auth' }
    });

    const { data: { session } } = await _sb.auth.getSession();
    if (session?.user) {
      await showDashboard(session.user, session.access_token);
    }
  });

  // ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function adminLogin() {
    const email    = document.getElementById('admin-email').value.trim();
    const password = document.getElementById('admin-password').value;
    const errEl    = document.getElementById('login-error');
    const btn      = document.getElementById('btn-login');

    errEl.textContent = '';
    if (!email || !password) { errEl.textContent = 'Enter email and password.'; return; }

    btn.disabled = true;
    btn.textContent = 'Signing in‚Ä¶';

    const { data, error } = await _sb.auth.signInWithPassword({ email, password });
    btn.disabled = false;
    btn.textContent = 'Sign In';

    if (error) { errEl.textContent = error.message; return; }
    await showDashboard(data.user, data.session.access_token);
  }

  // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function showDashboard(user, token) {
    document.getElementById('admin-user-email').textContent = user.email;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    await loadOrders(token);
  }

  async function loadOrders(token) {
    // Use the token from the current session if not passed
    if (!token) {
      const { data: { session } } = await _sb.auth.getSession();
      token = session?.access_token;
    }

    try {
      const res = await fetch('/api/admin/orders', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (res.status === 403) {
        document.getElementById('table-loading').textContent =
          '‚õî Access denied. Your email is not in the admin list.';
        return;
      }

      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json();
      _allOrders = json.orders || [];

      // Stats
      document.getElementById('stat-total').textContent   = json.stats.total;
      document.getElementById('stat-revenue').textContent = `$${json.stats.totalRevenue}`;
      document.getElementById('stat-today').textContent   = `$${json.stats.todayRevenue}`;
      document.getElementById('stat-pending').textContent = json.stats.statusCounts.pending || 0;
      document.getElementById('stat-shipped').textContent = json.stats.statusCounts.shipped || 0;

      document.getElementById('table-loading').style.display = 'none';
      renderTable();

    } catch(err) {
      document.getElementById('table-loading').textContent = 'Error loading orders: ' + err.message;
    }
  }

  // ‚îÄ‚îÄ Filter & Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setFilter(filter, btn) {
    _currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTable();
  }

  function renderTable() {
    const search  = (document.getElementById('search-input').value || '').toLowerCase();
    const tbody   = document.getElementById('orders-tbody');
    const table   = document.getElementById('orders-table');
    const empty   = document.getElementById('table-empty');

    let rows = _allOrders.filter(o => {
      if (_currentFilter !== 'all' && o.status !== _currentFilter) return false;
      if (search) {
        const hay = `${o.buyer_email || ''} ${o.paypal_order_id || ''} ${o.id || ''}`.toLowerCase();
        if (!hay.includes(search)) return false;
      }
      return true;
    });

    if (rows.length === 0) {
      table.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    table.style.display = 'table';
    empty.style.display = 'none';

    tbody.innerHTML = rows.map(o => {
      const date  = new Date(o.created_at).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
      const shortId = (o.paypal_order_id || o.id || '').toString().substring(0, 12).toUpperCase();
      const items = (Array.isArray(o.items) ? o.items : [])
        .map(i => `${i.typeLabel || i.type} ${i.selectedSize}/${i.selectedColor}`)
        .join(', ');
      const statusClass = `status-${o.status || 'pending'}`;
      const statusLabel = (o.status || 'pending').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      const tracking = o.tracking_number
        ? `<a class="track-link" href="${o.tracking_url || `https://track.aftership.com/${o.tracking_number}`}" target="_blank">${o.tracking_number}</a>`
        : '<span style="color:#333">‚Äî</span>';

      return `
        <tr>
          <td>${date}</td>
          <td><span class="order-id">${shortId}</span></td>
          <td class="hide-mobile" style="color:#888;font-size:.8rem">${o.buyer_email || '‚Äî'}</td>
          <td><div class="items-summary">${items || '‚Äî'}</div></td>
          <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
          <td class="amount">$${Number(o.total_amount || 0).toFixed(2)}</td>
          <td class="hide-mobile">${tracking}</td>
        </tr>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function adminLogout() {
    await _sb.auth.signOut();
    location.reload();
  }
</script>
</body>
</html>
